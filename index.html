<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒ­ãƒ¼ãƒ— (Rope) - Zen Commander</title>
    <style>
        :root { 
            --accent: #00ffcc; --bg: #0f0f10; --card: #1a1a1b; 
            --primary-btn: #007bff; --success-btn: #28a745;
            --forest-bg: #1b261e; --forest-accent: #a3b18a;
        }
        html, body { height: 100%; overflow: hidden; margin: 0; }
        body { 
            background-color: var(--bg); color: #e0e0e0; font-family: sans-serif; 
            display: flex; flex-direction: column; align-items: center; 
            padding: 20px; box-sizing: border-box; transition: background-color 1.5s; 
        }
        body.forest-mode { background-color: var(--forest-bg); color: #dad7cd; }
        .container { display: flex; flex-direction: column; width: 100%; max-width: 500px; height: 100%; }
        
        #fetch-btn { 
            width: 100%; background: #333; border: 2px solid #444; color: #fff; 
            padding: 25px; font-size: 22px; font-weight: 900; border-radius: 12px; 
            cursor: pointer; margin-top: 20px; transition: 0.3s; flex-shrink: 0;
        }
        #fetch-btn.hidden { display: none; }

        .header-info { flex-shrink: 0; text-align: center; }
        #timer { font-size: 72px; font-weight: 200; margin: 0; color: var(--accent); letter-spacing: -2px; }
        body.forest-mode #timer { color: var(--forest-accent); }
        #target-slot-name { font-size: 24px; color: var(--primary-btn); font-weight: bold; }
        #phase-name { font-size: 32px; color: #ffcc00; font-weight: bold; }
        #phase-msg { font-size: 15px; color: #bbb; height: 3em; margin: 5px 0; line-height: 1.4; }
        
        .content-area { 
            display: none; background: var(--card); border-radius: 12px; padding: 10px; 
            text-align: left; border: 1px solid #333; 
            flex-grow: 1; overflow-y: auto; margin-bottom: 15px;
        }
        .content-area.active { display: block; }
        body.forest-mode .content-area { background: #344e41; border-color: #588157; }
        
        .task-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #2a2a2b; font-size: 20px; }
        .task-item input[type="checkbox"] { width: 30px; height: 30px; margin-right: 15px; }
        textarea#review-note { width: 100%; height: 100%; min-height: 200px; background: transparent; color: #fff; border: none; padding: 15px; box-sizing: border-box; font-size: 18px; resize: none; outline: none; }
        .footer-action { display: none; flex-shrink: 0; padding-bottom: 10px; }
        .footer-action.active { display: block; }
        button#action-btn { width: 100%; padding: 25px; font-size: 24px; cursor: pointer; border: none; border-radius: 16px; font-weight: bold; color: white; }
        .btn-start { background: var(--primary-btn); }
        .btn-next { background: var(--success-btn); }
        .guide-box { background:#2c3e50; padding:15px; border-radius:8px; margin-bottom:15px; font-size:14px; border-left:4px solid var(--accent); color:#fff; line-height:1.6; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-info">
        <div id="target-slot-name">READY</div>
        <div id="phase-name">ROPE</div>
        <div id="timer">00:00</div>
        <div id="phase-msg">ä»»å‹™ã‚’åŒæœŸã—ã¦ã€å‡ºé™£ã›ã‚ˆã€‚</div>
    </div>
    <button id="fetch-btn" onclick="fetchTasks()">âš¡ ä»»å‹™ã‚’åŒæœŸ</button>
    <div id="main-content" class="content-area"></div>
    <div id="footer-action" class="footer-action">
        <button id="action-btn" class="btn-start" onclick="handleAction()">å‡ºé™£ (START)</button>
    </div>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwxdSKt2gETr_2mRV7sQ4RFKS7j_c79eBAJAX36t2bfEU_gyW0TDHi5hnPbH2VDBi46Jw/exec";
    const slotKeys = ["ãƒãƒ¢â‘ ", "ãƒãƒ¢â‘¡", "ãƒãƒ¢â‘¢", "ãƒãƒ¢â‘£"];
    let currentSlotIndex = 0;
    let currentPhaseIndex = -1;
    let timerId = null;
    let timeLeft = 0;
    let audioCtx = null;
    let noiseNode = null;
    let fireplaceNode = null;
    let pomoData = null;

    const phases = [
        { name: "Scout", time: 1 * 60, msg: "è§£åƒåº¦ã‚’ä¸Šã’ã‚ˆã€‚" },
        { name: "Rush", time: 20 * 60, msg: "é›†ä¸­ã€‚å®Œç’§ã‚’æ±‚ã‚ã‚‹ãªã€‚" },
        { name: "Pass", time: 3 * 60, msg: "ä¸­ç¶™ã€‚ç²—ãã¦ã‚‚æŠ•ã’ã‚ã€‚" },
        { name: "Knot", time: 2 * 60, msg: "çµã³ç›®ã€‚ä»»å‹™ã‚’åµå¯Ÿä¸­..." },
        { name: "Clean", time: 1 * 60, msg: "æˆ¦å ´ã‚’æ¸…ã‚ã‚ˆã€‚" },
        { name: "Brief", time: 3 * 60, msg: "å®Œå…¨ã«é›¢ã‚Œã‚ˆã€‚" }
    ];

    // --- éŸ³éŸ¿ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆå¼·åŒ–ç‰ˆï¼‰ ---
    function initAudio() {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!audioCtx) {
            audioCtx = new AudioContext();
        } else if (audioCtx.state === 'suspended' || audioCtx.state === 'closed') {
            audioCtx.resume().catch(() => {
                // å¾©å¸°å¤±æ•—æ™‚ã¯å†ä½œæˆ
                audioCtx = new AudioContext();
            });
        }
    }

    function notifyUser() {
        try {
            initAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(880, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.3);
        } catch(e) { console.error("Beep Error", e); }
        if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
    }

    function stopAllNoise() {
        if (noiseNode) { 
            try { noiseNode.stop(); noiseNode.disconnect(); } catch(e){} 
            noiseNode = null; 
        }
        if (fireplaceNode) { 
            try { fireplaceNode.stop(); fireplaceNode.disconnect(); } catch(e){} 
            fireplaceNode = null; 
        }
    }

    // ãƒ–ãƒ©ã‚¦ãƒ³ãƒã‚¤ã‚ºï¼ˆå®Ÿéš›ã¯ä½éŸ³ãƒ•ã‚£ãƒ«ã‚¿ã‚’é€šã—ãŸãƒ›ãƒ¯ã‚¤ãƒˆãƒã‚¤ã‚ºï¼‰
    function playFocusNoise() {
        stopAllNoise();
        initAudio();
        
        // 5ç§’åˆ†ã®ãƒãƒƒãƒ•ã‚¡ã‚’ä½œæˆï¼ˆãƒ«ãƒ¼ãƒ—ã•ã›ã‚‹ï¼‰
        const bufferSize = 5 * audioCtx.sampleRate;
        const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
        const output = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) { 
            output[i] = Math.random() * 2 - 1; // ãƒ›ãƒ¯ã‚¤ãƒˆãƒã‚¤ã‚º
        }

        noiseNode = audioCtx.createBufferSource();
        noiseNode.buffer = buffer;
        noiseNode.loop = true;

        // ãƒ­ãƒ¼ãƒ‘ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ã§ãƒ–ãƒ©ã‚¦ãƒ³ãƒã‚¤ã‚ºé¢¨ã«ã™ã‚‹
        const filter = audioCtx.createBiquadFilter();
        filter.type = 'lowpass';
        filter.frequency.setValueAtTime(300, audioCtx.currentTime); // 300Hzä»¥ä¸‹ã‚’é€šã™ï¼ˆã‚´ãƒ¼ã£ã¨ã„ã†éŸ³ï¼‰
        
        const gain = audioCtx.createGain();
        gain.gain.setValueAtTime(0.15, audioCtx.currentTime); // éŸ³é‡

        noiseNode.connect(filter).connect(gain).connect(audioCtx.destination);
        noiseNode.start();
    }

    // ä¼‘æ¯ç”¨ã‚µã‚¦ãƒ³ãƒ‰ï¼ˆãƒ›ãƒ¯ã‚¤ãƒˆãƒã‚¤ã‚ºï¼‹ç„šãç«ï¼‰
    function playDeepRestSound() {
        stopAllNoise();
        initAudio();

        const bufferSize = 5 * audioCtx.sampleRate;
        const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
        const output = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) { output[i] = Math.random() * 2 - 1; }
        
        // 1. èƒŒæ™¯ã®ã‚µãƒ¼ãƒƒã¨ã„ã†éŸ³ï¼ˆãƒ›ãƒ¯ã‚¤ãƒˆãƒã‚¤ã‚ºå¼±ï¼‰
        noiseNode = audioCtx.createBufferSource();
        noiseNode.buffer = buffer;
        noiseNode.loop = true;
        const noiseGain = audioCtx.createGain();
        noiseGain.gain.setValueAtTime(0.02, audioCtx.currentTime);
        noiseNode.connect(noiseGain).connect(audioCtx.destination);
        noiseNode.start();

        // 2. ç„šãç«ã®ãƒ‘ãƒãƒ‘ãƒéŸ³ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ãŸãƒã‚¤ã‚ºï¼‰
        fireplaceNode = audioCtx.createBufferSource();
        fireplaceNode.buffer = buffer;
        fireplaceNode.loop = true;
        
        // ç„šãç«é¢¨ãƒ•ã‚£ãƒ«ã‚¿
        const filter = audioCtx.createBiquadFilter();
        filter.type = 'lowpass';
        filter.frequency.setValueAtTime(500, audioCtx.currentTime);
        
        const fireGain = audioCtx.createGain();
        fireGain.gain.setValueAtTime(0.15, audioCtx.currentTime);
        
        fireplaceNode.connect(filter).connect(fireGain).connect(audioCtx.destination);
        fireplaceNode.start();
    }

    // --- ã‚·ã‚¹ãƒ†ãƒ åˆ¶å¾¡ ---
    async function fetchTasks(isAuto = false) {
        if(!isAuto) {
            const btn = document.getElementById('fetch-btn');
            if(btn) btn.textContent = "åµå¯Ÿä¸­...";
        }
        try {
            const res = await fetch(GAS_URL);
            pomoData = await res.json();
            if(!isAuto) {
                document.getElementById('fetch-btn').classList.add('hidden');
                document.getElementById('main-content').classList.add('active');
                document.getElementById('footer-action').classList.add('active');
            }
            refreshDisplay();
        } catch (e) { if(!isAuto) alert("åŒæœŸå¤±æ•—ã€‚"); }
    }

    function refreshDisplay() {
        const main = document.getElementById('main-content');
        main.innerHTML = "";
        const currentPhaseName = (currentPhaseIndex >= 0 && currentPhaseIndex < phases.length) ? phases[currentPhaseIndex].name : "";
        
        if (currentPhaseIndex === 98 || currentPhaseIndex === 99) {
            document.getElementById('target-slot-name').textContent = "GREAT REST";
            if (currentPhaseIndex === 98) {
                const area = document.createElement('textarea');
                area.id = "review-note";
                area.placeholder = "æˆ¦æœã‚„èª²é¡Œã‚’è¨˜ã›...";
                main.appendChild(area);
            } else {
                main.innerHTML = `<div style="height:100%; display:flex; align-items:center; justify-content:center; font-style:italic; opacity:0.6;">Deep Relaxation... ğŸ”¥</div>`;
            }
            return;
        }

        if (["Clean", "Brief"].includes(currentPhaseName)) {
            main.innerHTML = `<div style="height:100%; display:flex; align-items:center; justify-content:center; color:#666; font-style:italic;">${currentPhaseName === "Clean" ? "æˆ¦å ´ã‚’æ¸…ã‚ã‚ˆ..." : "å¿ƒã‚’è§£ãæ”¾ã¦..."}</div>`;
            return;
        }

        const key = slotKeys[currentSlotIndex];
        document.getElementById('target-slot-name').textContent = key;

        // ã‚¬ã‚¤ãƒ‰è¡¨ç¤º
        if (currentSlotIndex === 0) {
            main.innerHTML += `<div class="guide-box" style="border-left-color:#ffcc00;"><strong>ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­â‘ ï¼šINBOXã‚¼ãƒ­ï¼ˆåˆ†è§£ãƒ»åˆ†é¡ï¼‰</strong><br>â‘ -1.ã‚¿ã‚¹ã‚¯ã‚’25åˆ†å˜ä½ã«åˆ†è§£ã€‚<br>â‘ -2.æ‰“è¨ºå…ˆã‚’æ±ºå®šã€‚<br>â‘ -3.æƒ…å ±ã‚’åˆ†é¡ã€‚<br>â‘ -4.æ›–æ˜§ãªã‚‚ã®ã¯somedayã¸ã€‚</div>`;
        } else if (currentSlotIndex === 1) {
            main.innerHTML += `<div class="guide-box"><strong>ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­â‘¡ï¼šã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸€æ–‰æƒè¨ï¼‰</strong><br>â‘¡-1.2åˆ†ãƒ«ãƒ¼ãƒ«ã§æ‰“è¨ºã‚’ä¸€æ°—ã«æ”¾ã¤ã€‚<br>â‘¡-2.ã€Œé€£çµ¡å¾…ã¡ã€ãƒªã‚¹ãƒˆã¸ç™»éŒ²ã€‚<br>â‘¡-3.3æ—¥å¾Œã¾ã§ã®ã€†åˆ‡ç¢ºèªã€‚</div>`;
        }

        const data = pomoData ? pomoData[key] : null;
        if (!data || data.tasks.length === 0) {
            main.innerHTML += '<div style="color:#444; padding:20px; text-align:center;">ï¼ˆä»»å‹™ãªã—ï¼‰</div>';
            return;
        }
        data.tasks.forEach(task => {
            const div = document.createElement('div');
            div.className = "task-item";
            div.innerHTML = `<input type="checkbox" class="task-check" data-id="${task.id}"> <span>${task.title}</span>`;
            main.appendChild(div);
        });
    }

    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ³ãƒ‰ãƒ©ï¼ˆå¿…ãšã“ã“ã§AudioContextã‚’å©ãèµ·ã“ã™ï¼‰
    async function handleAction() {
        initAudio(); // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ç¢ºå®Ÿã«å†é–‹ãƒ»åˆæœŸåŒ–
        notifyUser(); // æ“ä½œéŸ³

        if (timerId) {
            clearInterval(timerId);
            timerId = null;
            await reportCheckedTasks();
            if (currentPhaseIndex === 98) startForestRest();
            else startNextPhase();
        } else {
            startNextPhase();
        }
    }

    function startNextPhase() {
        if (currentPhaseIndex === 99) {
            stopAllNoise();
            location.reload();
            return;
        }

        currentPhaseIndex++;
        if (currentPhaseIndex >= phases.length) {
            currentPhaseIndex = -1;
            currentSlotIndex++;
            if (currentSlotIndex >= slotKeys.length) startGrandReview();
            else { setupStandby(); refreshDisplay(); }
            return;
        }

        const p = phases[currentPhaseIndex];
        document.getElementById('phase-name').textContent = p.name;
        document.getElementById('phase-msg').textContent = p.msg;
        timeLeft = p.time;
        
        if(p.name === "Knot") fetchTasks(true);

        // ãƒ•ã‚§ãƒ¼ã‚ºé€²è¡Œä¸­ã®ãƒã‚¤ã‚ºå†ç”Ÿ
        playFocusNoise();

        document.getElementById('action-btn').textContent = `${p.name}å®Œäº† (NEXT)`;
        document.getElementById('action-btn').className = "btn-next";
        refreshDisplay();
        startTimer();
    }

    function startGrandReview() {
        notifyUser();
        document.body.classList.add('forest-mode');
        currentPhaseIndex = 98;
        document.getElementById('phase-name').textContent = "REVIEW";
        document.getElementById('phase-msg').textContent = "æˆ¦æœã‚’è¨˜ã›ã€‚";
        timeLeft = 15 * 60;
        
        playDeepRestSound();

        document.getElementById('action-btn').textContent = "æŒ¯ã‚Šè¿”ã‚Šå®Œäº†";
        document.getElementById('action-btn').className = "btn-next";
        refreshDisplay();
        startTimer();
    }

    function startForestRest() {
        notifyUser();
        currentPhaseIndex = 99;
        document.getElementById('phase-name').textContent = "FOREST REST";
        document.getElementById('phase-msg').textContent = "æ·±ã„ä¼‘æ¯ã‚’ã€‚";
        timeLeft = 15 * 60;
        
        playDeepRestSound();

        document.getElementById('action-btn').textContent = "ä¼‘æ¯çµ‚äº† (EXIT)";
        document.getElementById('action-btn').className = "btn-start";
        refreshDisplay();
        startTimer();
    }

    function startTimer() {
        if (timerId) clearInterval(timerId);
        updateDisplay();
        timerId = setInterval(() => {
            timeLeft--;
            updateDisplay();
            if (timeLeft <= 0) {
                clearInterval(timerId);
                timerId = null;
                notifyUser(); // è‡ªå‹•å®Œäº†æ™‚ã®Beep
                if (currentPhaseIndex === 98) startForestRest();
                else if (currentPhaseIndex === 99) {}
                else { reportCheckedTasks(); startNextPhase(); }
            }
        }, 1000);
    }

    function updateDisplay() {
        let m = Math.floor(timeLeft / 60);
        let s = timeLeft % 60;
        document.getElementById('timer').textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }

    async function reportCheckedTasks() {
        if (currentPhaseIndex >= 98 || !pomoData) return;
        const slotName = slotKeys[currentSlotIndex];
        const checks = document.querySelectorAll('.task-check:checked');
        for (let cb of Array.from(checks)) {
            const taskTitle = cb.nextElementSibling.textContent.trim();
            const taskId = cb.getAttribute('data-id');
            const url = `${GAS_URL}?action=complete&slotName=${encodeURIComponent(slotName)}&taskTitle=${encodeURIComponent(taskTitle)}`;
            fetch(url, { mode: 'no-cors' });
            pomoData[slotName].tasks = pomoData[slotName].tasks.filter(t => t.id !== taskId);
            cb.parentElement.remove();
        }
    }

    function setupStandby() {
        stopAllNoise(); // å¾…æ©Ÿä¸­ã¯éŸ³ã‚’æ­¢ã‚ã‚‹ï¼ˆãƒãƒƒãƒ†ãƒªãƒ¼ç¯€ç´„ã¨ãƒ¡ãƒªãƒãƒªï¼‰
        document.getElementById('target-slot-name').textContent = "READY";
        document.getElementById('phase-name').textContent = "ROPE";
        document.getElementById('timer').textContent = "00:00";
        document.getElementById('phase-msg').textContent = "ä»»å‹™ã‚’åŒæœŸã—ã¦ã€å‡ºé™£ã›ã‚ˆã€‚";
        const btn = document.getElementById('action-btn');
        btn.textContent = "å‡ºé™£ (START)";
        btn.className = "btn-start";
    }
</script>
</body>
</html>

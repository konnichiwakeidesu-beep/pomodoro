<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ロープ (Rope) - Task Commander</title>
    <style>
        :root { --accent: #00ffcc; --bg: #0f0f10; --card: #1a1a1b; --primary-btn: #007bff; --success-btn: #28a745; }
        body { background-color: var(--bg); color: #e0e0e0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .container { text-align: center; width: 100%; max-width: 500px; }
        
        #fetch-btn { width: 100%; background: #333; border: 1px solid #444; color: #fff; padding: 15px; font-size: 16px; font-weight: bold; border-radius: 12px; cursor: pointer; margin-bottom: 20px; }

        #timer { font-size: 90px; font-weight: 200; margin: 5px 0; color: var(--accent); letter-spacing: -2px; }
        #phase-name { font-size: 32px; color: #ffcc00; font-weight: bold; }
        #phase-msg { font-size: 16px; color: #bbb; min-height: 3.5em; margin: 15px 0; line-height: 1.5; }
        
        .slot-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
        .pomo-slot { background: var(--card); border: 2px solid #333; border-radius: 12px; padding: 15px; cursor: pointer; text-align: left; }
        .pomo-slot.active { border-color: var(--primary-btn); background: #001a33; }
        .pomo-slot.empty { color: #555; border-style: dashed; }

        .task-list-area { background: var(--card); border-radius: 12px; padding: 10px; text-align: left; margin-bottom: 20px; border: 1px solid #333; }
        .task-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #2a2a2b; font-size: 18px; }
        .task-item:last-child { border-bottom: none; }
        .task-item input[type="checkbox"] { width: 24px; height: 24px; margin-right: 15px; cursor: pointer; }

        button#action-btn { width: 100%; padding: 20px; font-size: 22px; cursor: pointer; border: none; border-radius: 12px; font-weight: bold; transition: 0.3s; color: white; }
        .btn-start { background: var(--primary-btn); }
        .btn-next { background: var(--success-btn); }
        button:disabled { background: #222 !important; color: #555 !important; }
    </style>
</head>
<body>

<div class="container">
    <button id="fetch-btn" onclick="fetchTasks()">⚡ 任務を同期 (Google Tasks)</button>
    
    <div class="slot-container" id="slot-container"></div>

    <div id="phase-name">READY</div>
    <div id="timer">00:00</div>
    <div id="phase-msg">任務を選択し、出陣せよ。</div>

    <div style="text-align: left; margin-bottom: 8px; color: #666; font-size: 12px; text-transform: uppercase;">Missions in this slot</div>
    <div id="task-list-area" class="task-list-area">
        <div style="color: #444; padding: 10px;">スロットを選択すると任務が表示されます</div>
    </div>

    <div class="controls">
        <button id="action-btn" class="btn-start" onclick="handleAction()">出陣 (START)</button>
    </div>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwBywrRzY_9UFjnXMck_zXnL5cxegZuXNaX37BR5C4tLDycr_zlRQPSe2_wNXW5EC8cRw/exec";
    let currentPhaseIndex = -1;
    let timerId = null;
    let timeLeft = 0;
    let audioCtx = null;
    let pomoTasks = {};
    let currentListId = null;

    const phases = [
        { name: "Scout", time: 1 * 60, msg: "1分だけやるとしたら何ができる？" },
        { name: "Rush", time: 20 * 60, msg: "集中せよ。完璧を求めるな。" },
        { name: "Pass", time: 3 * 60, msg: "中継の時間だ。粗くても投げろ。" },
        { name: "Knot", time: 2 * 60, msg: "結び目を打て。次への一歩を刻め。" },
        { name: "Clean", time: 1 * 60, msg: "戦場を片付けよ。準備は万全か？" },
        { name: "Brief", time: 3 * 60, msg: "完全に離れよ。英気を養え。" }
    ];

    async function fetchTasks() {
        const btn = document.getElementById('fetch-btn');
        btn.textContent = "偵察中...";
        try {
            const res = await fetch(GAS_URL);
            pomoTasks = await res.json();
            renderSlots();
            btn.textContent = "✅ 同期完了";
            setTimeout(() => btn.textContent = "⚡ 任務を同期 (Google Tasks)", 2000);
        } catch (e) {
            alert("通信失敗。デプロイ設定を『全員』にしているか確認してくれ。");
        }
    }

    function renderSlots() {
        const container = document.getElementById('slot-container');
        container.innerHTML = "";
        ["ポモ①", "ポモ②", "ポモ③", "ポモ④"].forEach(key => {
            const data = pomoTasks[key];
            const div = document.createElement('div');
            div.className = `pomo-slot ${data && data.tasks.length > 0 ? '' : 'empty'}`;
            div.innerHTML = `<strong>${key}</strong>${data && data.tasks.length > 0 ? data.tasks[0].title + (data.tasks.length > 1 ? ' 他' : '') : '（空）'}`;
            div.onclick = function() { selectSlot(key, div); };
            container.appendChild(div);
        });
    }

    function selectSlot(key, element) {
        if (timerId) return;
        const data = pomoTasks[key];
        const listArea = document.getElementById('task-list-area');
        listArea.innerHTML = "";
        currentListId = data.listId;

        if (!data || data.tasks.length === 0) {
            listArea.innerHTML = '<div style="color:#444; padding:10px;">任務なし</div>';
            return;
        }

        data.tasks.forEach(task => {
            const div = document.createElement('div');
            div.className = "task-item";
            div.innerHTML = `<input type="checkbox" class="task-check" data-id="${task.id}"> <span>${task.title}</span>`;
            listArea.appendChild(div);
        });
        
        document.querySelectorAll('.pomo-slot').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
    }

    async function handleAction() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();

        if (!timerId) {
            startNextPhase();
        } else {
            clearInterval(timerId);
            timerId = null;
            playBeep();
            // 完了ボタンが押されたとき、チェック済みのタスクを報告
            await reportCheckedTasks();
            startNextPhase();
        }
    }

// HTML内の該当箇所を差し替え
async function reportCheckedTasks() {
    const checks = document.querySelectorAll('.task-check:checked');
    if (checks.length === 0) return;

    for (const cb of Array.from(checks)) {
        const taskId = cb.getAttribute('data-id');
        const url = `${GAS_URL}?action=complete&listId=${currentListId}&taskId=${taskId}`;
        
        try {
            // mode: 'no-cors' を一旦外し、標準的なフェッチを試みる
            // これで動かない場合は、GASのデプロイが「全員」になっているか再確認
            await fetch(url); 
            cb.parentElement.style.opacity = "0.3";
            cb.disabled = true;
            console.log("完了報告送信完了:", taskId);
        } catch (err) {
            console.error("報告エラー:", err);
            // 失敗した場合は no-cors で再試行
            fetch(url, { mode: 'no-cors' });
            cb.parentElement.style.opacity = "0.3";
        }
    }
}

    function startNextPhase() {
        currentPhaseIndex++;
        if (currentPhaseIndex >= phases.length) {
            currentPhaseIndex = -1;
            setupStandby();
            return;
        }
        const p = phases[currentPhaseIndex];
        document.getElementById('phase-name').textContent = p.name;
        document.getElementById('phase-msg').innerHTML = p.msg;
        timeLeft = p.time;
        const btn = document.getElementById('action-btn');
        btn.textContent = `${p.name}完了 (NEXT)`;
        btn.className = "btn-next";
        startTimer();
    }

    function startTimer() {
        timerId = setInterval(() => {
            timeLeft--;
            updateDisplay();
            if (timeLeft <= 0) {
                clearInterval(timerId);
                timerId = null;
                playBeep();
                reportCheckedTasks(); // 時間切れ時もチェック済みは報告
                startNextPhase();
            }
        }, 1000);
    }

    function updateDisplay() {
        let m = Math.floor(timeLeft / 60);
        let s = timeLeft % 60;
        document.getElementById('timer').textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }

    function playBeep() {
        try {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.5);
        } catch(e) {}
    }

    function setupStandby() {
        timerId = null;
        document.getElementById('phase-name').textContent = "READY";
        document.getElementById('timer').textContent = "00:00";
        document.getElementById('phase-msg').textContent = "任務を選択し、出陣せよ。";
        const btn = document.getElementById('action-btn');
        btn.textContent = "出陣 (START)";
        btn.className = "btn-start";
    }
</script>
</body>
</html>

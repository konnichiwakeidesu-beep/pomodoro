<script>
    // クォーテーションで囲ったぞ！
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzka8ljRTcY9vdplfDElRITo7rjFNtQtUVdAFaMc0OuLPsBLIwlX42slLCSzIq2Gp9Zcg/exec"; 
    let currentPhaseIndex = -1;
    let timerId = null;
    let timeLeft = 0;
    let audioCtx = null;
    let pomoTasks = {};

    // --- 以下、既存のロジック ---
    const phases = [
        { name: "Scout (偵察)", time: 1 * 60, msg: "1分だけやるとしたら<br>なにをしたらいいだろう？" },
        { name: "Rush (集中)", time: 20 * 60, msg: "どういう形にしたら前に進めるだろう？" },
        { name: "Pass (中継)", time: 3 * 60, msg: "粗くても、今投げたほうが相手は助かるのではないか？" },
        { name: "Knot (結び目)", time: 2 * 60, msg: "一瞬で再開できる状態にしたか？" },
        { name: "Clean (撤収)", time: 1 * 60, msg: "次のことを一瞬で開始できるか？" },
        { name: "Brief (休止)", time: 3 * 60, msg: "一度ロープを離せ。次の一撃に備えよ。" }
    ];

    async function fetchTasks() {
        try {
            if (!GAS_URL.startsWith("http")) return alert("GASのURLをセットしてください。");
            const res = await fetch(GAS_URL);
            pomoTasks = await res.json();
            renderSlots();
        } catch (e) {
            alert("通信に失敗した。GASのデプロイ設定（全員に公開されているか）を確認してくれ。");
        }
    }

    function renderSlots() {
        const container = document.getElementById('slot-container');
        container.innerHTML = "";
        ["ポモ①", "ポモ②", "ポモ③", "ポモ④"].forEach(key => {
            const task = pomoTasks[key];
            const div = document.createElement('div');
            div.className = `pomo-slot ${task ? '' : 'empty'}`;
            div.innerHTML = `<strong>${key}</strong><br>${task ? task.title : '（空）'}`;
            div.onclick = () => selectSlot(key);
            container.appendChild(div);
        });
    }

    function selectSlot(key) {
        const task = pomoTasks[key];
        if (!task) return alert("このスロットは空です。スキップします。");
        document.getElementById('task-title').value = task.title;
        document.getElementById('task-detail').value = task.detail;
        document.querySelectorAll('.pomo-slot').forEach(el => el.classList.remove('active'));
        // 選択されたスロットを視覚的に強調
        const slots = document.querySelectorAll('.pomo-slot');
        const index = ["ポモ①", "ポモ②", "ポモ③", "ポモ④"].indexOf(key);
        if(slots[index]) slots[index].classList.add('active');
    }

    function pressActionBtn() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();

        if (currentPhaseIndex === -1 || currentPhaseIndex >= phases.length - 1) {
            startNextPhase();
        }
    }

    function startNextPhase() {
        currentPhaseIndex++;
        if (currentPhaseIndex >= phases.length) {
            currentPhaseIndex = -1;
            setupStandby();
            return;
        }

        const p = phases[currentPhaseIndex];
        document.getElementById('phase-name').textContent = p.name;
        document.getElementById('phase-msg').innerHTML = p.msg;
        timeLeft = p.time;
        
        startTimer();
    }

    function startTimer() {
        const btn = document.getElementById('action-btn');
        btn.disabled = true;
        btn.textContent = "遂行中...";
        
        if (timerId) clearInterval(timerId);
        timerId = setInterval(() => {
            timeLeft--;
            updateDisplay();
            if (timeLeft <= 0) {
                clearInterval(timerId);
                playBeep();
                startNextPhase();
            }
        }, 1000);
    }

    function updateDisplay() {
        let m = Math.floor(timeLeft / 60);
        let s = timeLeft % 60;
        document.getElementById('timer').textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }

    function playBeep() {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.5);
    }

    function setupStandby() {
        document.getElementById('phase-name').textContent = "待機中";
        document.getElementById('action-btn').disabled = false;
        document.getElementById('action-btn').textContent = "出陣（開始）";
    }
</script>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ロープ - Rope</title>
    <style>
        body { background-color: #050505; color: #d1d1d1; font-family: 'Helvetica Neue', Arial, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; transition: background-color 0.5s; }
        .container { text-align: center; width: 90%; max-width: 500px; padding: 30px; border-radius: 12px; background: #0f0f10; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #timer { font-size: 100px; font-weight: 900; margin: 10px 0; color: #f0f0f0; letter-spacing: -2px; }
        #phase-name { font-size: 20px; font-weight: bold; color: #ff3b30; text-transform: uppercase; letter-spacing: 2px; }
        body.relay-mode { background-color: #440000; }
        body.relay-mode #timer { color: #ff3b30; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        .input-group { margin-bottom: 20px; text-align: left; }
        label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 8px; color: #666; text-transform: uppercase; }
        input[type="text"], textarea { width: 100%; background: #1a1a1b; border: 1px solid #333; color: #fff; padding: 12px; box-sizing: border-box; border-radius: 6px; font-size: 15px; }
        textarea { height: 100px; }
        .controls { display: flex; gap: 10px; justify-content: center; margin-top: 30px; }
        button { padding: 15px 30px; font-size: 14px; font-weight: bold; cursor: pointer; border: none; border-radius: 6px; background: #222; color: #fff; text-transform: uppercase; transition: 0.2s; min-width: 120px; }
        button#action-btn { background: #ff3b30; }
        #pomo-info { margin-top: 15px; color: #888; font-size: 14px; }
        .rope-msg { margin-top: 25px; font-size: 16px; font-weight: bold; color: #ffcc00; font-style: italic; min-height: 48px; line-height: 1.5; white-space: pre-wrap; }
    </style>
</head>
<body>

<div class="container">
    <div id="phase-name">READY</div>
    <div id="timer">25:00</div>
    <div id="pomo-info">完了: 0 / 目標: 4</div>

    <div class="input-group">
        <label>Next Relay Point (中継点)</label>
        <input type="text" id="task-title" placeholder="誰に、何を渡す？">
    </div>
    <div class="input-group">
        <label>Knots (結び目・報告下書き)</label>
        <textarea id="task-detail" placeholder="1分・22分・2分・1分・1分・3分。"></textarea>
    </div>

    <div class="controls">
        <button id="action-btn">出陣 (Engage)</button>
        <button onclick="resetTimer()">Reset</button>
    </div>
    <div id="rope-msg" class="rope-msg"></div>
</div>

<script>
    let timerId;
    let timeLeft;
    let currentPhaseIndex = -1; // 開始前は-1
    let completedPomo = 0;
    const targetPomo = 4;
    let audioCtx = null;
    let isLongBreak = false;

    const standardLoop = [
        { name: "Scout (着手)", time: 1 * 60, msg: "1分だけやるとしたら、\n何から手をつけるべきか？" },
        { name: "Rush (実行)", time: 22 * 60, msg: "どうすれば前に進めるか？\n協力し合える形を目指そう。" },
        { name: "Pass (まとめ)", time: 2 * 60, msg: "丁寧すぎて待たせていないか？\n丁寧にしたい旨を伝えよう。" },
        { name: "Knot (報告)", time: 1 * 60, msg: "次にすべきことを書き出し、\n一瞬で再開できる状態にせよ。" },
        { name: "Clean (片付け)", time: 1 * 60, msg: "次のことを一瞬で\n開始できる状態にしたか？" },
        { name: "Brief (休憩)", time: 3 * 60, msg: "一度ロープを離せ。\n疲弊せぬよう、次の一撃に備えよ。" }
    ];

    const longBreakLoop = [
        { name: "Review (復習)", time: 15 * 60, msg: "ここまでのロープの繋がりを俯瞰し、\n次ポモを選択せよ。" },
        { name: "Rest (深呼吸)", time: 15 * 60, msg: "全軍休息。\n英気を養い、次の3〜4ポモに備えよ。" }
    ];

    const timerDisplay = document.getElementById('timer');
    const phaseDisplay = document.getElementById('phase-name');
    const msgDisplay = document.getElementById('rope-msg');
    const actionBtn = document.getElementById('action-btn');
    const pomoInfo = document.getElementById('pomo-info');

    function playBeep() {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.frequency.setValueAtTime(880, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.4);
    }

    function updateDisplay() {
        let mins = Math.floor(timeLeft / 60);
        let secs = timeLeft % 60;
        timerDisplay.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function nextPhase() {
        playBeep();
        currentPhaseIndex++;
        
        let currentLoop = isLongBreak ? longBreakLoop : standardLoop;

        // ループ終了判定
        if (currentPhaseIndex >= currentLoop.length) {
            currentPhaseIndex = 0;
            if (!isLongBreak) {
                completedPomo++;
                pomoInfo.textContent = `完了: ${completedPomo} / 目標: ${targetPomo}`;
                if (completedPomo % targetPomo === 0) {
                    isLongBreak = true;
                    currentLoop = longBreakLoop;
                }
            } else {
                isLongBreak = false;
                currentLoop = standardLoop;
            }
        }

        let phase = currentLoop[currentPhaseIndex];
        phaseDisplay.textContent = phase.name;
        msgDisplay.innerText = phase.msg; // 改行反映のためinnerText
        timeLeft = phase.time;
        
        if (phase.name.includes("Pass") || isLongBreak) {
            document.body.classList.add('relay-mode');
        } else {
            document.body.classList.remove('relay-mode');
        }

        // ボタンのテキスト変更
        actionBtn.textContent = "完了 (Done)";
        startTimer();
    }

    function startTimer() {
        if (timerId) clearInterval(timerId);
        timerId = setInterval(() => {
            timeLeft--;
            updateDisplay();
            if (timeLeft <= 0) {
                clearInterval(timerId);
                timerId = null;
                nextPhase();
            }
        }, 1000);
    }

    actionBtn.onclick = () => {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        nextPhase(); // ボタンを押すと即座に次のフェーズへ
    };

    function resetTimer() {
        clearInterval(timerId);
        timerId = null;
        timeLeft = 0;
        currentPhaseIndex = -1;
        completedPomo = 0;
        isLongBreak = false;
        document.body.classList.remove('relay-mode');
        phaseDisplay.textContent = "READY";
        msgDisplay.innerText = "";
        timerDisplay.textContent = "25:00";
        pomoInfo.textContent = `完了: 0 / 目標: ${targetPomo}`;
        actionBtn.textContent = "出陣 (Engage)";
    }
</script>
</body>
</html>

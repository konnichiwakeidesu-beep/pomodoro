<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>集中ループ Master</title>
    <style>
        body { background-color: #0f0f10; color: #e0e0e0; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .container { text-align: center; width: 90%; max-width: 500px; }
        #timer { font-size: 80px; font-weight: bold; margin: 20px 0; color: #00ffcc; }
        #phase-name { font-size: 24px; color: #ffcc00; margin-bottom: 10px; }
        .input-group { margin-bottom: 15px; text-align: left; }
        label { display: block; font-size: 14px; margin-bottom: 5px; color: #888; }
        input[type="text"], textarea { width: 100%; background: #1a1a1b; border: 1px solid #333; color: #fff; padding: 10px; box-sizing: border-box; border-radius: 4px; }
        textarea { height: 80px; resize: none; }
        .controls { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        button { padding: 12px 24px; font-size: 16px; cursor: pointer; border: none; border-radius: 4px; background: #333; color: #fff; transition: 0.3s; }
        button#start-btn { background: #007bff; }
        button#start-btn:hover { background: #0056b3; }
        .info { margin-top: 20px; font-size: 14px; color: #666; }
    </style>
</head>
<body>

<div class="container">
    <div id="phase-name">待機中</div>
    <div id="timer">25:00</div>

    <div class="input-group">
        <label>現在のタスク（タイトル）</label>
        <input type="text" id="task-title" placeholder="例：立教大学 パスナビ提案資料作成">
    </div>
    <div class="input-group">
        <label>タスクの詳細・メモ</label>
        <textarea id="task-detail" placeholder="スプレッドシートから抜き出した詳細をここに貼ってください"></textarea>
    </div>

    <div class="input-group" style="display: flex; align-items: center; gap: 10px;">
        <label style="margin:0;">目標ポモ数:</label>
        <input type="number" id="target-pomo" value="4" min="1" style="width: 60px; background: #1a1a1b; border: 1px solid #333; color: #fff; padding: 5px;">
        <span id="pomo-count">完了: 0</span>
    </div>

    <div class="controls">
        <button id="start-btn">出陣（スタート）</button>
        <button onclick="resetTimer()">リセット</button>
    </div>
    
    <div class="info">※開始ボタンを押すと音響の権限が解放されます。</div>
</div>

<script>
    let timerId;
    let timeLeft;
    let currentPhase = 0;
    let completedPomo = 0;
    let audioCtx = null;

    // フェーズ定義: 3〜4ポモ後の15分休憩を含む
    const basePhases = [
        { name: "まず始める（導入）", time: 1 * 60 },
        { name: "集中する（本番）", time: 22 * 60 },
        { name: "完了報告（言語化）", time: 2 * 60 },
        { name: "振り返り", time: 1 * 60 },
        { name: "片付け", time: 1 * 60 },
        { name: "短い休憩", time: 3 * 60 }
    ];

    const longBreakPhases = [
        { name: "復習・次ポモの選択", time: 15 * 60 },
        { name: "しっかり休憩", time: 15 * 60 }
    ];

    const startBtn = document.getElementById('start-btn');
    const timerDisplay = document.getElementById('timer');
    const phaseDisplay = document.getElementById('phase-name');
    const pomoDisplay = document.getElementById('pomo-count');

    function initAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
    }

    function playBeep() {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(880, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.5);
    }

    function updateDisplay() {
        let mins = Math.floor(timeLeft / 60);
        let secs = timeLeft % 60;
        timerDisplay.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function nextPhase() {
        playBeep();
        
        // 1ループ（basePhases）が終わったかチェック
        if (currentPhase >= basePhases.length) {
            completedPomo++;
            pomoDisplay.textContent = `完了: ${completedPomo}`;
            currentPhase = 0;

            const target = parseInt(document.getElementById('target-pomo').value);
            if (completedPomo % target === 0) {
                // 指定ポモ数に達したら15分ずつの休憩フェーズへ
                runSpecialBreak();
                return;
            }
        }

        let phase = basePhases[currentPhase];
        phaseDisplay.textContent = phase.name;
        timeLeft = phase.time;
        currentPhase++;
    }

    function runSpecialBreak() {
        let breakStep = 0;
        function nextBreakStep() {
            playBeep();
            if (breakStep < longBreakPhases.length) {
                let p = longBreakPhases[breakStep];
                phaseDisplay.textContent = p.name;
                timeLeft = p.time;
                breakStep++;
            } else {
                currentPhase = 0;
                nextPhase();
            }
        }
        nextBreakStep();
    }

    startBtn.onclick = () => {
        initAudio(); // ユーザー操作時にAudioContextを初期化
        if (timerId) return;
        
        if (!timeLeft) nextPhase();
        
        timerId = setInterval(() => {
            timeLeft--;
            updateDisplay();
            if (timeLeft <= 0) {
                clearInterval(timerId);
                timerId = null;
                nextPhase();
                startBtn.click(); // 自動で次のフェーズを開始
            }
        }, 1000);
    };

    function resetTimer() {
        clearInterval(timerId);
        timerId = null;
        timeLeft = 0;
        currentPhase = 0;
        completedPomo = 0;
        phaseDisplay.textContent = "待機中";
        timerDisplay.textContent = "25:00";
        pomoDisplay.textContent = "完了: 0";
    }
</script>
</body>
</html>

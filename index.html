<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ロープ (Rope) - Zen Commander</title>
    <style>
        :root { 
            --accent: #00ffcc; --bg: #0f0f10; --card: #1a1a1b; 
            --primary-btn: #007bff; --success-btn: #28a745;
            --forest-bg: #1b261e; --forest-accent: #a3b18a;
        }
        html, body { height: 100%; overflow: hidden; margin: 0; }
        body { 
            background-color: var(--bg); color: #e0e0e0; font-family: sans-serif; 
            display: flex; flex-direction: column; align-items: center; 
            padding: 20px; box-sizing: border-box; transition: background-color 1.5s; 
        }
        body.forest-mode { background-color: var(--forest-bg); color: #dad7cd; }
        .container { display: flex; flex-direction: column; width: 100%; max-width: 500px; height: 100%; }
        
        #fetch-btn { 
            width: 100%; background: #333; border: 2px solid #444; color: #fff; 
            padding: 25px; font-size: 22px; font-weight: 900; border-radius: 12px; 
            cursor: pointer; margin-top: 20px; transition: 0.3s; flex-shrink: 0;
        }
        #fetch-btn.hidden { display: none; }

        .header-info { flex-shrink: 0; text-align: center; }
        #timer { font-size: 72px; font-weight: 200; margin: 0; color: var(--accent); letter-spacing: -2px; }
        body.forest-mode #timer { color: var(--forest-accent); }
        #target-slot-name { font-size: 24px; color: var(--primary-btn); font-weight: bold; }
        #phase-name { font-size: 32px; color: #ffcc00; font-weight: bold; }
        #phase-msg { font-size: 15px; color: #bbb; height: 3em; margin: 5px 0; line-height: 1.4; }
        
        .content-area { 
            display: none; background: var(--card); border-radius: 12px; padding: 5px; 
            text-align: left; border: 1px solid #333; 
            flex-grow: 1; overflow-y: auto; margin-bottom: 15px;
            -webkit-overflow-scrolling: touch;
        }
        .content-area.active { display: block; }
        body.forest-mode .content-area { background: #344e41; border-color: #588157; }
        
        .task-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #2a2a2b; font-size: 20px; }
        .task-item.done { opacity: 0.1; display: none; } /* 完了したものは即座に非表示 */
        .task-item input[type="checkbox"] { width: 30px; height: 30px; margin-right: 15px; }

        textarea#review-note { width: 100%; height: 100%; min-height: 200px; background: transparent; color: #fff; border: none; padding: 15px; box-sizing: border-box; font-size: 18px; resize: none; outline: none; }

        .footer-action { display: none; flex-shrink: 0; padding-bottom: 10px; }
        .footer-action.active { display: block; }
        button#action-btn { 
            width: 100%; padding: 25px; font-size: 24px; cursor: pointer; 
            border: none; border-radius: 16px; font-weight: bold; color: white;
        }
        .btn-start { background: var(--primary-btn); }
        .btn-next { background: var(--success-btn); }
    </style>
</head>
<body>

<div class="container">
    <div class="header-info">
        <div id="target-slot-name">READY</div>
        <div id="phase-name">ROPE</div>
        <div id="timer">00:00</div>
        <div id="phase-msg">任務を同期して、出陣せよ。</div>
    </div>

    <button id="fetch-btn" onclick="fetchTasks()">⚡ 任務を同期</button>
    <div id="main-content" class="content-area"></div>

    <div id="footer-action" class="footer-action">
        <button id="action-btn" class="btn-start" onclick="handleAction()">出陣 (START)</button>
    </div>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwxdSKt2gETr_2mRV7sQ4RFKS7j_c79eBAJAX36t2bfEU_gyW0TDHi5hnPbH2VDBi46Jw/exec";
    const slotKeys = ["ポモ①", "ポモ②", "ポモ③", "ポモ④"];
    let currentSlotIndex = 0;
    let currentPhaseIndex = -1;
    let timerId = null;
    let timeLeft = 0;
    let audioCtx = null;
    let pomoData = null;

    const phases = [
        { name: "Scout", time: 1 * 60, msg: "解像度を上げよ。" },
        { name: "Rush", time: 20 * 60, msg: "集中。完璧を求めるな。" },
        { name: "Pass", time: 3 * 60, msg: "中継。粗くても投げろ。" },
        { name: "Knot", time: 2 * 60, msg: "結び目。積み残しを凝視せよ。" },
        { name: "Clean", time: 1 * 60, msg: "戦場を片付けよ。" },
        { name: "Brief", time: 3 * 60, msg: "完全に離れよ。" }
    ];

    async function fetchTasks() {
        const btn = document.getElementById('fetch-btn');
        btn.textContent = "偵察中...";
        try {
            const res = await fetch(GAS_URL);
            pomoData = await res.json();
            btn.classList.add('hidden');
            document.getElementById('main-content').classList.add('active');
            document.getElementById('footer-action').classList.add('active');
            currentSlotIndex = 0;
            currentPhaseIndex = -1;
            document.body.classList.remove('forest-mode');
            refreshDisplay();
        } catch (e) { alert("同期失敗。"); btn.textContent = "❌ 再試行"; }
    }

    function refreshDisplay() {
        const main = document.getElementById('main-content');
        main.innerHTML = "";
        
        if (currentPhaseIndex === 98 || currentPhaseIndex === 99) {
            const area = document.createElement('textarea');
            area.id = "review-note";
            area.placeholder = "戦果や課題を記せ...";
            main.appendChild(area);
            document.getElementById('target-slot-name').textContent = "BLOCK COMPLETED";
            return;
        }

        const currentPhaseName = currentPhaseIndex >= 0 ? phases[currentPhaseIndex].name : "";
        const key = slotKeys[currentSlotIndex];
        document.getElementById('target-slot-name').textContent = key;
        
        const data = pomoData ? pomoData[key] : null;
        if (!data || data.tasks.length === 0) {
            main.innerHTML = '<div style="color:#444; padding:20px; text-align:center;">（任務なし）</div>';
            return;
        }

  data.tasks.forEach(task => {
            const div = document.createElement('div');
            div.className = "task-item";
            const currentPhaseName = currentPhaseIndex >= 0 ? phases[currentPhaseIndex].name : "";
            const showCheckbox = !["Clean", "Brief"].includes(currentPhaseName);
            
            if (showCheckbox) {
                // チェックボックスがある状態
                div.innerHTML = `<input type="checkbox" class="task-check" data-id="${task.id}"> <span>${task.title}</span>`;
            } else {
                // チェックボックスがない状態でも、<span>でタイトルを囲む（取得しやすくするため）
                div.innerHTML = `<span style="margin-left:45px; opacity:0.6;">${task.title}</span>`;
            }
            main.appendChild(div);
        });
    }

    async function handleAction() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();

        if (timerId) {
            clearInterval(timerId);
            timerId = null;
            notifyUser();
            await reportCheckedTasks(); // ここで完了タスクをデータから削除する
            startNextPhase();
        } else {
            if (!pomoData) return alert("先に同期を。");
            startNextPhase();
        }
    }

async function reportCheckedTasks() {
    // 振り返りや休息フェーズ、またはデータがない場合は何もしない
    if (currentPhaseIndex >= 98 || !pomoData) return;
    
    const slotName = slotKeys[currentSlotIndex]; // 「ポモ①」など
    const checks = document.querySelectorAll('.task-check:checked');
    
    for (let cb of Array.from(checks)) {
        if (cb.disabled) continue; 
        
        // タスクのタイトルを正確に取得
        const taskTitle = cb.nextElementSibling.textContent.trim();
        const taskId = cb.getAttribute('data-id'); 
        
        // 先ほど成功した「必中URL」と同じパラメータ構成
        const url = `${GAS_URL}?action=complete&slotName=${encodeURIComponent(slotName)}&taskTitle=${encodeURIComponent(taskTitle)}`;
        
        // 伝令を放つ（成功・失敗を待たずに次へ進む）
        fetch(url, { mode: 'no-cors' });
        
        // 画面上の処理：リストから削除し、チェックボックスを無効化
        pomoData[slotName].tasks = pomoData[slotName].tasks.filter(t => t.id !== taskId);
        cb.parentElement.classList.add('done');
        cb.disabled = true;
    }
}

    function startNextPhase() {
        if (currentPhaseIndex === 99) {
            document.getElementById('fetch-btn').classList.remove('hidden');
            document.getElementById('main-content').classList.remove('active');
            document.getElementById('footer-action').classList.remove('active');
            currentSlotIndex = 0;
            currentPhaseIndex = -1;
            document.body.classList.remove('forest-mode');
            setupStandby();
            return;
        }

        if (currentPhaseIndex === 98) {
            startForestRest();
            return;
        }

        currentPhaseIndex++;
        
        if (currentPhaseIndex >= phases.length) {
            currentPhaseIndex = -1;
            currentSlotIndex++;
            if (currentSlotIndex >= slotKeys.length) {
                startGrandBrief();
            } else {
                setupStandby();
                refreshDisplay();
            }
            return;
        }

        const p = phases[currentPhaseIndex];
        document.getElementById('phase-name').textContent = p.name;
        document.getElementById('phase-msg').innerHTML = p.msg;
        timeLeft = p.time;
        
        const btn = document.getElementById('action-btn');
        btn.textContent = `${p.name}完了 (NEXT)`;
        btn.className = "btn-next";
        refreshDisplay();
        startTimer();
    }

    function startGrandBrief() {
        document.body.classList.add('forest-mode');
        currentPhaseIndex = 98;
        document.getElementById('phase-name').textContent = "REVIEW";
        document.getElementById('phase-msg').innerHTML = "戦果を記せ。";
        timeLeft = 15 * 60;
        const btn = document.getElementById('action-btn');
        btn.textContent = "振り返り完了";
        btn.className = "btn-next";
        refreshDisplay();
        startTimer();
    }

    function startForestRest() {
        currentPhaseIndex = 99;
        document.getElementById('phase-name').textContent = "FOREST REST";
        document.getElementById('phase-msg').innerHTML = "深い休息を。";
        timeLeft = 15 * 60;
        const btn = document.getElementById('action-btn');
        btn.textContent = "休息終了 (EXIT)";
        btn.className = "btn-start";
        refreshDisplay();
        startTimer();
    }

    function startTimer() {
        if (timerId) clearInterval(timerId);
        timerId = setInterval(() => {
            timeLeft--;
            updateDisplay();
            if (timeLeft <= 0) {
                clearInterval(timerId);
                timerId = null;
                notifyUser();
                reportCheckedTasks();
                startNextPhase();
            }
        }, 1000);
    }

    function updateDisplay() {
        let m = Math.floor(timeLeft / 60);
        let s = timeLeft % 60;
        document.getElementById('timer').textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }

    function notifyUser() {
        if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
    }

    function setupStandby() {
        document.getElementById('phase-name').textContent = "ROPE";
        document.getElementById('timer').textContent = "00:00";
        document.getElementById('phase-msg').textContent = "任務を同期して、出陣せよ。";
        const btn = document.getElementById('action-btn');
        btn.textContent = "出陣 (START)";
        btn.className = "btn-start";
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ロープ (Rope) - 繋ぐための時間管理</title>
    <style>
        body { background-color: #0f0f10; color: #e0e0e0; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .container { text-align: center; width: 100%; max-width: 500px; }
        #timer { font-size: 80px; font-weight: bold; margin: 10px 0; color: #00ffcc; text-shadow: 0 0 20px rgba(0,255,204,0.3); }
        #phase-name { font-size: 28px; color: #ffcc00; font-weight: bold; }
        #phase-msg { font-size: 16px; color: #bbb; min-height: 4em; margin: 10px 0; line-height: 1.6; }
        .input-group { margin-bottom: 15px; text-align: left; }
        label { display: block; font-size: 14px; margin-bottom: 5px; color: #888; }
        input[type="text"], textarea { width: 100%; background: #1a1a1b; border: 1px solid #333; color: #fff; padding: 12px; box-sizing: border-box; border-radius: 4px; font-size: 16px; }
        textarea { height: 80px; resize: none; }
        .controls { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        button { padding: 18px; font-size: 20px; cursor: pointer; border: none; border-radius: 8px; font-weight: bold; transition: 0.2s; }
        #action-btn { background: #007bff; color: white; box-shadow: 0 4px 15px rgba(0,123,255,0.4); }
        #action-btn:active { transform: translateY(2px); }
        #action-btn:disabled { background: #222; color: #555; box-shadow: none; cursor: default; }
        #reset-btn { background: none; color: #555; font-size: 14px; text-decoration: underline; margin-top: 10px; }
        .pomo-info { margin-top: 15px; font-size: 14px; color: #666; }
    </style>
</head>
<body>

<div class="container">
    <div id="phase-name">待機中</div>
    <div id="phase-msg">「ロープ」を投げる準備を。<br>軍議を開始せよ。</div>
    <div id="timer">00:00</div>

    <div class="input-group">
        <label>現在の任務</label>
        <input type="text" id="task-title" placeholder="何を中継するか？">
    </div>
    <div class="input-group">
        <label>戦況メモ / 次への結び目</label>
        <textarea id="task-detail" placeholder="中断時に「次はここから」を書き残せ"></textarea>
    </div>

    <div class="pomo-info">
        <span id="pomo-count">完了ポモ: 0</span>
    </div>

    <div class="controls">
        <button id="action-btn">出陣（開始）</button>
        <button id="reset-btn" onclick="resetTimer()">リセット</button>
    </div>
</div>

<script>
    let timerId = null;
    let timeLeft = 0;
    let currentPhaseIndex = -1;
    let completedPomo = 0;
    let audioCtx = null;

    const phases = [
        { name: "Scout (偵察)", time: 1 * 60, msg: "1分だけやるとしたら<br>なにをしたらいいだろう？" },
        { name: "Rush (集中)", time: 20 * 60, msg: "どういう形にしたら前に進めるだろう？<br>協力してもらう形にしよう" },
        { name: "Pass (中継)", time: 3 * 60, msg: "粗くても、今投げたほうが相手は助かるのではないか？<br>丁寧にしたいと考えていることを伝えよう" },
        { name: "Knot (結び目)", time: 2 * 60, msg: "次にすべきことを書き出そう。<br>一瞬で再開できる状態にしたか？" },
        { name: "Clean (撤収)", time: 1 * 60, msg: "次のことを一瞬で開始できる状態にしたか？" },
        { name: "Brief (休止)", time: 3 * 60, msg: "一度ロープを離せ。<br>次の一撃に備えよ。" }
    ];

    const actionBtn = document.getElementById('action-btn');
    const timerDisplay = document.getElementById('timer');
    const phaseNameDisplay = document.getElementById('phase-name');
    const phaseMsgDisplay = document.getElementById('phase-msg');
    const pomoDisplay = document.getElementById('pomo-count');

    function initAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
    }

    function playBeep() {
        initAudio();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(880, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.5);
    }

    function updateDisplay() {
        let mins = Math.floor(timeLeft / 60);
        let secs = timeLeft % 60;
        timerDisplay.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function startNextPhase() {
        currentPhaseIndex++;
        
        if (currentPhaseIndex >= phases.length) {
            completedPomo++;
            pomoDisplay.textContent = `完了ポモ: ${completedPomo}`;
            currentPhaseIndex = 0;
        }

        const p = phases[currentPhaseIndex];
        phaseNameDisplay.textContent = p.name;
        phaseMsgDisplay.innerHTML = p.msg;
        timeLeft = p.time;
        updateDisplay();
        
        startTimer();
    }

    function startTimer() {
        if (timerId) clearInterval(timerId);
        actionBtn.textContent = "遂行中...";
        actionBtn.disabled = true;
        
        timerId = setInterval(() => {
            timeLeft--;
            updateDisplay();
            if (timeLeft <= 0) {
                clearInterval(timerId);
                timerId = null;
                playBeep();
                actionBtn.textContent = "完了（次へ）";
                actionBtn.disabled = false;
            }
        }, 1000);
    }

    actionBtn.onclick = () => {
        initAudio();
        if (actionBtn.textContent === "出陣（開始）" || actionBtn.textContent === "完了（次へ）") {
            startNextPhase();
        }
    };

    function resetTimer() {
        if (!confirm("最初からやり直すか？")) return;
        clearInterval(timerId);
        timerId = null;
        timeLeft = 0;
        currentPhaseIndex = -1;
        phaseNameDisplay.textContent = "待機中";
        phaseMsgDisplay.textContent = "「ロープ」を投げる準備を。";
        timerDisplay.textContent = "00:00";
        actionBtn.textContent = "出陣（開始）";
        actionBtn.disabled = false;
    }
</script>
</body>
</html>

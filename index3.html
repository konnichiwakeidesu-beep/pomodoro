<!DOCTYPE html>
<html lang="ja">
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111111">
  <meta charset="UTF-8">
  <title>é›†ä¸­ãƒ«ãƒ¼ãƒ— æœ€çµ‚ç‰ˆ+</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      text-align: center;
      margin-top: 40px;
    }
    #phase {
      font-size: 22px;
      margin-bottom: 6px;
    }
    #timer {
      font-size: 48px;
      margin: 10px;
    }
    #count {
      margin-top: 8px;
      font-size: 16px;
    }
    textarea {
      width: 80%;
      height: 80px;
      margin-top: 10px;
      font-size: 14px;
    }
    button {
      font-size: 18px;
      padding: 8px 20px;
      margin: 10px 6px;
    }
    #completeBtn {
      background: #222;
      color: #fff;
    }
  </style>
</head>
<body>

  <div id="phase"></div>
  <div id="timer"></div>
  <div id="count"></div>

  <div id="inputArea">
    <textarea id="memo"></textarea>
  </div>

  <div>
    <button onclick="start()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    <button id="completeBtn" onclick="completePhase()" style="display:none;">
      å®Œäº†
    </button>
  </div>

<script>
/* =========================
   ãƒ•ã‚§ãƒ¼ã‚ºå®šç¾©
========================= */

const basePhases = [
  {
    name: "1åˆ†ï½œã¾ãšå§‹ã‚ã‚‹",
    time: 60,
    input: true,
    placeholder: "ãƒãƒ¼ãƒˆã‚·ã‚§ãƒ«ãƒ•ã‚’é–‹ã‘ï¼ã‚¿ã‚¹ã‚¯ã‚’è»¢è¨˜ã—ã‚ï¼",
    autoStart: false
  },
  {
    name: "22åˆ†ï½œé›†ä¸­ã™ã‚‹",
    time: 1320,
    input: false,
    canComplete: true
  },
  {
    name: "2åˆ†ï½œå®Œäº†å ±å‘Š",
    time: 120,
    input: true,
    placeholder: "ã§ããŸã“ã¨ã‚’ä¸€è¨€ã§",
    canComplete: true
  },
  {
    name: "1åˆ†ï½œæŒ¯ã‚Šè¿”ã‚Š",
    time: 60,
    input: true,
    placeholder: "æ°—ã¥ããƒ»è©°ã¾ã‚Š"
  },
  {
    name: "1åˆ†ï½œç‰‡ä»˜ã‘",
    time: 60,
    input: false
  },
  {
    name: "3åˆ†ï½œä¼‘æ†©",
    time: 180,
    input: false,
    endOfCycle: true
  }
];

// 4ãƒãƒ¢å¾Œã®ç‰¹åˆ¥ä¼‘æ†©
const longRestPhases = [
  {
    name: "15åˆ†ï½œãƒ­ã‚°ï¼†æ—¥è¨˜",
    time: 900,
    input: true,
    placeholder: "ä»Šæ—¥ã®4ãƒãƒ¢ã§ã‚„ã£ãŸã“ã¨ãƒ»æ°—ã¥ã"
  },
  {
    name: "15åˆ†ï½œã—ã£ã‹ã‚Šä¼‘æ†©",
    time: 900,
    input: false
  }
];

let phases = [...basePhases];

/* =========================
   çŠ¶æ…‹
========================= */

let index = 0;
let time = phases[0].time;
let timer = null;

let pomodoroCount =
  Number(localStorage.getItem("pomodoroCount")) || 0;

/* =========================
   DOM
========================= */

const phaseEl = document.getElementById("phase");
const timerEl = document.getElementById("timer");
const countEl = document.getElementById("count");
const inputArea = document.getElementById("inputArea");
const memo = document.getElementById("memo");
const completeBtn = document.getElementById("completeBtn");

/* =========================
   åˆæœŸåŒ–
========================= */

function init() {
  updatePhase();
  updateTimer();
  updateCount();
}

/* =========================
   ã‚¿ã‚¤ãƒãƒ¼åˆ¶å¾¡
========================= */

function start() {
  if (timer) return;
  playSound();
  timer = setInterval(tick, 1000);
}

function tick() {
  time--;
  updateTimer();
  if (time <= 0) nextPhase();
}

function completePhase() {
  time = 0;
  nextPhase();
}

function nextPhase() {
  clearInterval(timer);
  timer = null;

  // ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­å®Œäº†
  if (phases[index].endOfCycle) {
    pomodoroCount++;
    localStorage.setItem("pomodoroCount", pomodoroCount);
    updateCount();

    // 4ãƒãƒ¢ã”ã¨ã«30åˆ†ä¼‘æ†©
    if (pomodoroCount % 4 === 0) {
      phases = [...basePhases, ...longRestPhases];
      index = basePhases.length - 1;
    }
  }

  index++;

  if (index >= phases.length) {
    phases = [...basePhases];
    index = 0;
  }

  time = phases[index].time;
  memo.value = "";

  updatePhase();
  updateTimer();
  playSound();

  if (phases[index].autoStart !== false) {
    start();
  }
}

/* =========================
   è¡¨ç¤ºæ›´æ–°
========================= */

function updatePhase() {
  const p = phases[index];
  phaseEl.innerText = p.name;
  inputArea.style.display = p.input ? "block" : "none";
  memo.placeholder = p.placeholder || "";

  // å®Œäº†ãƒœã‚¿ãƒ³åˆ¶å¾¡
  completeBtn.style.display =
    p.canComplete ? "inline-block" : "none";
}

function updateTimer() {
  const m = Math.floor(time / 60);
  const s = time % 60;
  timerEl.innerText =
    `${m}:${s.toString().padStart(2, "0")}`;
}

function updateCount() {
  countEl.innerText =
    `ğŸ… å®Œäº†ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ï¼š${pomodoroCount}`;
}

/* =========================
   éŸ³
========================= */

function playSound() {
  const ctx =
    new (window.AudioContext || window.webkitAudioContext)();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();

  osc.type = "sine";
  osc.frequency.value = 880;
  gain.gain.value = 0.08;

  osc.connect(gain);
  gain.connect(ctx.destination);

  osc.start();
  osc.stop(ctx.currentTime + 0.2);
}

init();
</script>

</body>
</html>
